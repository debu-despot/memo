# ファイルアップロード機能脆弱性対策

## 3行
* ファイルアップロード機能は悪意のあるファイルをアップロードされる可能性がある
* 悪意のあるファイルを受け入れるとサーバーの乗っ取りや情報漏洩などの被害が想定される
* アップロードされたファイルは非公開領域に実行権限を削除して保存し、場合によっては内容を加工する必要もある

## ファイルアップロード攻撃

ファイルアップロード機能を実装する際には悪意のあるファイルがアップロードされることを想定しなければならない。  
悪意のあるファイルとは例えば以下のようなものを指す。

* 不正な名前のファイル
* スクリプトを含んだファイル
* 容量が極端に大きいファイル

これらのファイルをアップロードして仕様にない動作を引き起こすことを**ファイルアップロード攻撃**と呼ぶ。

### 想定される被害

ファイルアップロード攻撃を受けた場合、以下のような被害が想定される。

* サーバーの乗っ取り  
スクリプトを含んだファイルをアップロードし、バックドアが仕込まれサーバーを乗っ取られる可能性がある。   
また乗っ取ったサーバーが他のサイバー攻撃に利用される場合もある。

* 情報漏洩  
サーバー上あるいは利用しているDB等から個人情報等の機密情報を盗まれる可能性がある。    

## ファイルアップロード攻撃への対策

### 基本対策
前提として対策はクライアントサイド、サーバーサイドともに行う必要がある。   
クライアントサイドで事前に足切りすることも重要だが、ユーザーはある程度データを操作することが出来るためサーバーでの対策は必須となる。

前提として攻撃のほとんどは悪意のあるスクリプトを含んだファイルをアップロードし、アクセス(サーバー上で実行)することで行われる。  
そのため攻撃者がアップロードしたファイルに関与出来ないようにした上で、万が一アクセスされた場合や管理側のミスによる実行を防ぐことが基本となる。  
具体的な対策は以下の通り。

* 非公開領域に保存する(アクセスさせない)
* ファイル名を変更する(ファイルを探しにくくする)
* 実行権限を削除する(そもそも実行させない)

### 不正な名前のファイル
不正なファイル名のファイルがアップロードされた場合、悪意のあるファイルをサーバーに配置されたり、サーバー上のファイル上書きされる可能性がある。  
不正なファイル名とは以下のようなものを指す。

* 意図していない拡張子(画像ファイルを想定しているのにscript.php等)  
実行ファイルや悪意あるスクリプトファイルがアップロードされ、実行される可能性がある。

* パス情報を含んだファイル(../../script.php等)   
意図していないディレクトリにファイルが配置、上書きされる可能性がある。  
サイトのページが書き換えられたり、最悪の場合サーバーの設定を変えられる場合もある。

これらの攻撃に対する対策は以下の通り。

* 受け入れる拡張子をホワイトリスト設定する(受け入れるファイルの厳格化)
* 拡張子は後方一致で確認する(二重拡張子などの対策)
* パス情報を含んでいるか確認する(不正箇所への配置防止)
* ファイル名を変更する(正当な名称への変更)

### スクリプトを含んだファイル
ファイルアップロード機能に対する攻撃で基本的な手法は、悪意のあるスクリプトを含んだファイルをアップロードし、実行することである。   
それらは上述の基本対策で十分だが、これらで防げない攻撃もある。  

例として事前に何らかの方法でバックドアを仕込み、画像ファイルのEXIFにスクリプトを書き込んで実行する攻撃があった。([BKDR_ZZPEG](https://blog.trendmicro.co.jp/archives/7760))    
加えて知らずにファイルに個人情報がメタ情報として埋め込まれている場合もある。そこから情報漏洩する可能性もある。例えばカメラで撮った画像ファイルに位置情報がメタ情報として埋め込まれていることがよくある。

またcsv等の高機能ソフトウェアで開かれる可能性のあるファイルに関しても注意が必要である。  
例えばcsvをexcelで開いた場合にマクロの有効無効に関わらずexcel関数が実行され、攻撃を受けるあるいは他のサイバー攻撃に利用されてしまう場合がある。

これらの攻撃に対する対策は以下の通り。

* メタ情報は削除する(リスクのある不要な情報を残さない)
* ファイル内容が適切か確認し、必要に応じて加工する(関数等の無効化)

### 容量が極端に大きいファイル
ファイル容量が大きいファイルをアップロードされると、サーバーのリソースが圧迫される。    

対策は以下の通り。

* 一定以上のサイズのファイルをアップロード、保存出来ないようにする(不要なリソースを消費しない)
* サーバー側でリクエストボディサイズを制限する(そもそも受け取らない)


## 参考サイト
* https://blog.flatt.tech/entry/file_upload_security
* https://qiita.com/ichimura/items/0c4e5d2dd6fe8b55018e
* https://www.excelspeedup.com/csvzeijyakusei/
* https://secuas-cloud.com/column/1269/